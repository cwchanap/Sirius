name: Godot Unit Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  GODOT_VERSION: 4.4.1
  EXPORT_NAME: Sirius
  DOTNET_VERSION: 8.0.x

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    name: Run GdUnit4 Tests
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache Godot
        id: cache-godot
        uses: actions/cache@v4
        with:
          path: |
            ~/godot
            ~/.local/share/godot
          key: godot-${{ env.GODOT_VERSION }}-mono-linux

      - name: Download and install Godot
        if: steps.cache-godot.outputs.cache-hit != 'true'
        run: |
          wget -q https://github.com/godotengine/godot/releases/download/${{ env.GODOT_VERSION }}-stable/Godot_v${{ env.GODOT_VERSION }}-stable_mono_linux_x86_64.zip
          unzip -q Godot_v${{ env.GODOT_VERSION }}-stable_mono_linux_x86_64.zip
          ls -la
          mkdir -p ~/godot
          find . -name "Godot*" -type f -executable
          chmod +x Godot_v${{ env.GODOT_VERSION }}-stable_mono_linux_x86_64/Godot_v${{ env.GODOT_VERSION }}-stable_mono_linux.x86_64
          mv Godot_v${{ env.GODOT_VERSION }}-stable_mono_linux_x86_64/Godot_v${{ env.GODOT_VERSION }}-stable_mono_linux.x86_64 ~/godot/godot
          mv Godot_v${{ env.GODOT_VERSION }}-stable_mono_linux_x86_64/GodotSharp ~/godot/

      - name: Add Godot to PATH
        run: echo "$HOME/godot" >> $GITHUB_PATH

      - name: Verify Godot installation
        run: |
          godot --version

      - name: Restore .NET dependencies
        run: dotnet restore Sirius.sln

      - name: Build project
        run: dotnet build Sirius.sln --configuration Release --no-restore

      - name: Import Godot assets
        run: |
          # Run Godot in headless mode to import assets and ensure .godot folder exists
          timeout 30 godot --headless --editor --quit || true
          sleep 2

      - name: Install GdUnit4 addon
        run: |
          # Download and install GdUnit4 addon
          mkdir -p addons
          cd addons
          wget -q https://github.com/godot-gdunit-labs/gdUnit4/archive/refs/tags/v5.0.0.zip -O gdUnit4.zip
          unzip -q gdUnit4.zip
          rm gdUnit4.zip
          rm -rf gdUnit4
          mv gdUnit4-5.0.0/addons/gdUnit4 ./
          rm -rf gdUnit4-5.0.0
          cd ..
          # Re-import with GdUnit4 addon
          timeout 30 godot --headless --editor --quit || true
          sleep 2

      - name: Run GdUnit4 tests
        run: |
          # Run tests using GdUnit4's command line runner
          # Use the .NET test adapter which integrates with GdUnit4
          dotnet test Sirius.sln --configuration Release --logger "console;verbosity=detailed"
        continue-on-error: false

      - name: Run .NET tests (alternative)
        if: failure()
        run: |
          # Fallback: try running via dotnet test without build requirement
          dotnet test Sirius.sln --verbosity normal --logger "console;verbosity=detailed" || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            .godot/
            TestResults/
          retention-days: 7

      - name: Test Report Summary
        if: always()
        run: |
          echo "## Test Execution Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Godot Version: ${{ env.GODOT_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- .NET Version: ${{ env.DOTNET_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests Location: tests/" >> $GITHUB_STEP_SUMMARY
